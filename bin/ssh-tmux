#!/usr/bin/env bash

# Configurable parameters
session=${TMX_SESSION_NAME:-tmx}
tmux_command=${TMX_COMMAND:-tmux}
ssh_command=${SSH_COMMAND:-ssh}
reconnect_interval=${RECONNECT_INTERVAL:-10}
alive_interval=${ALIVE_INTERVAL:-10}

ssh_opts=$*

ssh_default_opts="-t -oCompression=yes -oPreferredAuthentications=gssapi-with-mic,publickey,password -oCheckHostIP=no -oServerAliveInterval=${alive_interval}"
tmux_cmd="${tmux_command} attach -t ${session} || ${tmux_command} new-session -s ${session}"

while [ 1 ]; do
  command ${ssh_command} ${ssh_default_opts} ${ssh_opts} -- ${tmux_cmd}

  # Keep reconnecting when the disconnection is due to error (i.e., non user detached)
  if [ $? -ne 0 ]; then
    echo "SSH connection lost, reconnecting in ${reconnect_interval} seconds..."
    sleep ${reconnect_interval}
  fi
done

