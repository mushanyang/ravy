#!/usr/bin/env bash

# Configure these parameters
sleep=5
alive_interval=10
host=$1
session=${2:-tmx}
extra_opts=$3

SSH_OPTS="-oCompression=yes -oPreferredAuthentications=gssapi-with-mic,publickey,password -oCheckHostIP=no -oServerAliveInterval=$alive_interval"

TMUX_CMD="tmux attach -t $session || tmux new-session -s $session"

# Just keep reconnecting upon failure
while [ 1 ]; do
  command ssh -t $host $SSH_OPTS $extra_opts -- "$TMUX_CMD"

  # Don't reconnect if disconnection not due to error (i.e., user detached)
  if [ $? -eq 0 ]; then break; fi

  echo "SSH connection lost, reconnecting in $sleep seconds..."
  sleep $sleep
done

