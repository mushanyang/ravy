#!/usr/bin/env zsh

append_content_if_absent () {
  local file="$1" text="$2" appending=${3:-$2}
  if ! grep "$text" "$file" &>/dev/null; then
    [ -f "$appending" ] && cat "$appending" >> "$file" || echo "$appending" >> "$file"
  fi
}

RAVY="${0:A:h}"

echo "dotfiles"
append_content_if_absent $HOME/.zshrc "[ -f $RAVY/zshrc ] && source $RAVY/zshrc"
append_content_if_absent $HOME/.zshenv "[ -f $RAVY/zshenv ] && source $RAVY/zshenv"
append_content_if_absent $HOME/.gitconfig "path=$RAVY/gitconfig" "[include]\npath=$RAVY/gitconfig\npath=$RAVY/custom/gitconfig"
append_content_if_absent $HOME/.ignore "RAVY_TMP" "$RAVY/ignore"

echo "zplug"
[ -d $HOME/.zplug ] || git clone https://github.com/zplug/zplug $HOME/.zplug

echo "colorls"
mkdir -p $HOME/.config
rm -rf $HOME/.config/colorls
ln -s -f $RAVY/colorls $HOME/.config/colorls

echo "vim/neovim"
mkdir -p $HOME/.vim $HOME/.vim/bundle $HOME/.vim/tmp $HOME/.vim/autoload
[ -d $HOME/.config/nvim ] || ln -s -f $HOME/.vim $HOME/.config/nvim

append_content_if_absent $HOME/.vimrc "if filereadable(\"$RAVY/vimrc\") | source $RAVY/vimrc | endif"
append_content_if_absent $HOME/.config/nvim/init.vim "if filereadable(\"$RAVY/vimrc\") | source $RAVY/vimrc | endif"

[ -e $HOME/.vim/autoload/plug.vim ] || curl -sfLo $HOME/.vim/autoload/plug.vim \
  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

echo "vim plugins"
vim '+PlugUpdate' '+qall'

echo "tmux"
curl -sfLo $HOME/.tmux.conf \
  https://raw.githubusercontent.com/gpakosz/.tmux/master/.tmux.conf
ln -s -f $RAVY/tmux.conf.local $HOME/.tmux.conf.local

echo "custom configs"
mkdir -p "$RAVY/custom" "$RAVY/custom/bin" "$RAVY/custom/zsh-functions"
touch "$RAVY/custom/zshrc" "$RAVY/custom/vimrc" "$RAVY/custom/gitconfig"

command -v "$RAVY/custom/install" >/dev/null && "$RAVY/custom/install" || true
