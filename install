#!/usr/bin/env zsh

RAVY="${0:A:h}"

echo 'Linking dotfiles'
if [[ ! -f ~/.agignore ]]; then
  cat $RAVY/ignores >> ~/.agignore
fi

if ! grep "source $RAVY/zshrc" ~/.zshrc &>/dev/null; then
  echo "source $RAVY/zshrc" >> ~/.zshrc
fi
if ! grep "source $RAVY/zshenv" ~/.zshenv &>/dev/null; then
  echo "source $RAVY/zshenv" >> ~/.zshenv
fi
if ! grep "path=$RAVY/gitconfig" ~/.gitconfig &>/dev/null; then
  echo "[include]\npath=$RAVY/gitconfig\npath=$RAVY/custom/gitconfig" \
    >> ~/.gitconfig
fi
if ! grep "source $RAVY/tmux.conf" ~/.tmux.conf &>/dev/null; then
  echo "source $RAVY/tmux.conf" >> ~/.tmux.conf
fi

echo 'Configuring Vim/NeoVim'
if ! grep "source $RAVY/vimrc" ~/.vimrc &>/dev/null; then
  echo "source $RAVY/vimrc" >> ~/.vimrc
fi
mkdir -p ~/.vim ~/.vim/bundle ~/.vim/tmp ~/.config
[[ ! -d ~/.config/nvim ]] && ln -s -f ~/.vim ~/.config/nvim
ln -s -f ~/.vimrc ~/.config/nvim/init.vim

curl -sfLo ~/.vim/autoload/plug.vim --create-dirs \
  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

echo 'Touching custom files'
mkdir -p $RAVY/custom $RAVY/custom/bin $RAVY/custom/zsh-functions
touch $RAVY/custom/zshrc
touch $RAVY/custom/vimrc
touch $RAVY/custom/gitconfig

echo 'Installing Zplug'
git -C ~/.zplug pull --rebase || \
  git clone https://github.com/zplug/zplug ~/.zplug

echo 'Installing custom settings'
if command -v $RAVY/custom/install >/dev/null; then
  $RAVY/custom/install
fi

if [[ -d ~/Library/Rime ]]; then
  echo 'Installing rime custom settings'
  cp $RAVY/rime/* ~/Library/Rime
fi
